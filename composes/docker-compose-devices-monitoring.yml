name: monitoring

services:
  smartctl-exporter:
    image: prometheuscommunity/smartctl-exporter:latest
    container_name: smartctl-exporter
    hostname: ${HOSTNAME}
    privileged: true
    volumes:
      - /dev:/dev:ro
      - /run/udev:/run/udev:ro
    mem_limit: 128m
    cpus: 0.25
    ports:
      - "$SERVICES_HOST:$SMARTCTL_EXPORTER_PORT:9633"
    user: root
    command:
      - '--smartctl.path=/usr/sbin/smartctl'
      - '--web.listen-address=:9633'
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:9633/metrics"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  vmagent:
    depends_on:
      smartctl-exporter:
        condition: service_healthy
    volumes:
      - ../vm-agent/configs/prometheus-devices.yml:/etc/prometheus/configs/prometheus-devices.yml
